---
import ExpandedCalendar from './expandedCalendar.astro';

/**
 * Calendar Preview Component
 * Opens when #preview is clicked, closes when clicking outside or pressing ESC.
 */
---

<!-- 
COLORS

lion: #aa8f66
butterscotch: #ed9b40
jet: #363537 
-->
<div class="relative w-full h-auto">
  <div
    id="previewBox"
    class="fixed right-20 top-40 w-[90%] sm:w-[300px] bg-white text-black rounded-md shadow-lg ring opacity-0 pointer-events-none transition-all duration-300 -translate-y-2.5 z-9"
  >
    <div class="p-4 -pb-2">
      <!-- Header -->
      <h2 class="text-center font-bold text-lg mb-2 text-black">month</h2>
      <!-- Calendar grid -->
      <div
        id="days-of-the-week"
        class="grid grid-cols-7 gap-1 text-center font-semibold"
      >
        <div>M</div>
        <div>T</div>
        <div>W</div>
        <div>TH</div>
        <div>F</div>
        <div>S</div>
        <div>S</div>
      </div>
      <div class="relative group">
        <div class="grid grid-cols-7 grid-rows-5 gap-1 mt-2">
          {
            Array.from({ length: 35 }).map(() => (
              <div class="ring shadow-sm rounded h-6" />
            ))
          }
        </div>
        <button
          id="expandBox"
          class="absolute left-1/2 -translate-x-1/2 top-0 opacity-0 group-hover:opacity-100 bg-blue-50 text-xs px-2 py-1 rounded whitespace-nowrap transition ease-in-out duration:350 h-full w-full group-hover:cursor-pointer font-bold scale-40 group-hover:scale-100 ring-2"
          >EXPAND</button
        >
      </div>
    </div>
    <div id="legends" class="w-full h-auto px-3.75">
      <div class="bg-lion-900 ring ring-gray-600 gap-x-2 rounded">
        <span class="flex justify-around items-center mb-2">
          <h3 class="font-bold">Legends</h3><p class="text-[0.75em]">
            (hover for descriptions)
          </p>
        </span><div class="w-full h-auto flex justify-center items-center mb-5">
          <div
            class="w-[80%] flex justify-around ring p-1 rounded ring-gray-400 mb-2"
          >
            <div class="relative
        group
        inline-block">
              <!-- Colored box -->
              <div class="w-9 h-6 bg-green-500 rounded cursor-pointer"></div>

              <!-- Tooltip -->
              <div
                class="absolute left-1/2 -translate-x-1/2 top-8
           opacity-0 group-hover:opacity-100
           pointer-events-none
           bg-gray-900 text-white text-xs px-2 py-1 rounded
           whitespace-nowrap transition"
              >
                Available
              </div>
            </div>
            <div class="relative group inline-block">
              <!-- Colored box -->
              <div class="w-9 h-6 bg-red-500 rounded cursor-pointer"></div>

              <!-- Tooltip -->
              <div
                class="absolute left-1/2 -translate-x-1/2 top-8
           opacity-0 group-hover:opacity-100
           pointer-events-none
           bg-gray-900 text-white text-xs px-2 py-1 rounded
           whitespace-nowrap transition"
              >
                Closed/Fully Booked
              </div>
            </div>
            <div class="relative group inline-block">
              <!-- Colored box -->
              <div class="w-9 h-6 bg-yellow-500 rounded cursor-pointer"></div>

              <!-- Tooltip -->
              <div
                class="absolute left-1/2 -translate-x-1/2 top-8
           opacity-0 group-hover:opacity-100
           pointer-events-none
           bg-gray-900 text-white text-xs px-2 py-1 rounded
           whitespace-nowrap transition"
              >
                PROMO!
              </div>
            </div>
            <div class="relative group inline-block">
              <!-- Colored box -->
              <div class="w-9 h-6 bg-pink-500 rounded cursor-pointer"></div>

              <!-- Tooltip -->
              <div
                class="absolute left-1/2 -translate-x-1/2 top-8
           opacity-0 group-hover:opacity-100
           pointer-events-none
           bg-gray-900 text-white text-xs px-2 py-1 rounded
           whitespace-nowrap transition"
              >
                Open for a limited time
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <ExpandedCalendar />

  <script>
    const box = document.getElementById('previewBox');
    const expandBtn = document.getElementById('expandBox'); // your expand button ID

    let previewWasOpen = false; // remembers if preview was open before expanding

    if (box) {
      document.addEventListener('click', (e) => {
        const target = e.target;
        if (!target || !(target instanceof Element)) return;

        const clickedPreviewButton = target.closest('#preview');
        const clickedInside = box.contains(target);

        // Toggle preview from header button
        if (clickedPreviewButton) {
          const isOpen = box.classList.contains('opacity-100');

          if (isOpen) {
            previewWasOpen = false;
            closePreview();
          } else {
            previewWasOpen = true;
            openPreview();
          }
          return;
        }

        // Click outside preview closes it
        if (!clickedInside) {
          previewWasOpen = false;
          closePreview();
        }
      });
    }

    // EXPAND button hides preview ONLY visually
    if (expandBtn) {
      expandBtn.addEventListener('click', () => {
        if (box) {
          if (box.classList.contains('opacity-100')) {
            previewWasOpen = true; // remember it was open
            box.classList.add('opacity-0', 'pointer-events-none');
            box.classList.remove('opacity-100');
          } else {
            previewWasOpen = false;
          }
        }

        // tell expanded calendar to open
        document.dispatchEvent(new CustomEvent('open-expanded-calendar'));
      });
    }

    // When expanded calendar closes, restore preview ONLY if it was open before
    document.addEventListener('expanded-calendar-closed', () => {
      if (box) {
        box.classList.remove('opacity-0', 'pointer-events-none');
        box.classList.add('opacity-100');
      }
      previewWasOpen = false;
    });

    function openPreview() {
      box?.classList.add('opacity-100');
      box?.classList.remove('opacity-0', 'pointer-events-none');
    }

    function closePreview() {
      box?.classList.add('opacity-0', 'pointer-events-none');
      box?.classList.remove('opacity-100');
    }
  </script>

  <!-- OPTIONAL: Dynamic month rendering (kept OFF for now) -->
  <!--
<script>
  const today = new Date();
  const year = today.getFullYear();
  const month = today.getMonth();

  const daysInMonth = new Date(year, month + 1, 0).getDate();
  const firstDay = new Date(year, month, 1).getDay(); // 0â€“6

  const grid = document.querySelector('#calendar-grid');

  // Fill empty slots before first day
  for (let i = 0; i < firstDay; i++) {
    grid.innerHTML += `<div></div>`;
  }

  // Fill days
  for (let i = 1; i <= daysInMonth; i++) {
    grid.innerHTML += `<div class="ring shadow-sm rounded">${i}</div>`;
  }
</script>
-->
</div>
